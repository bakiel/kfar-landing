<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFAR Admin Dashboard</title>
    <link rel="icon" type="image/png" href="images/branding/kfar_eats_icon_leaf_gold.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #478c0b;
            --gold: #f6af0d;
            --cream: #fef9ef;
            --sage: #5ea410;
            --forest: #3a5a0a;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        .font-space {
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #478c0b 0%, #f6af0d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .sidebar-link {
            transition: all 0.2s ease;
        }
        
        .sidebar-link:hover {
            background-color: rgba(71, 140, 11, 0.1);
            border-left: 4px solid var(--primary);
            padding-left: 16px;
        }
        
        .editable:hover {
            background-color: rgba(246, 175, 13, 0.1);
            cursor: text;
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }
        
        .editable:focus {
            outline: 2px solid var(--gold);
            background-color: white;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-yellow-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="images/branding/kfar_eats_logo_africa_integration_gold_leaf.png" 
                     alt="KFAR" 
                     class="h-24 mx-auto mb-4">
                <h1 class="text-4xl font-space font-bold gradient-text mb-2">KFAR</h1>
                <p class="text-gray-600">Admin Dashboard</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="admin@kfareats.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="••••••••">
                </div>
                
                <button type="submit" 
                        class="w-full py-3 px-6 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all">
                    Sign In
                </button>
                
                <div class="text-center text-sm text-gray-600">
                    <p>Demo: admin@kfareats.com / admin123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="images/branding/kfar_eats_icon_leaf_gold.png" 
                         alt="KFAR" 
                         class="h-8 w-8">
                    <h1 class="text-2xl font-space font-bold gradient-text">KFAR Admin</h1>
                    <span class="text-sm text-gray-500">|</span>
                    <span class="text-sm text-gray-600">Welcome, Admin</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-sync text-gray-600"></i>
                    </button>
                    <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="logout()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="flex h-screen pt-16">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 overflow-y-auto">
                <div class="p-4 border-b border-gray-200 mb-4">
                    <img src="images/branding/kfar_eats_icon_africa_outline_gold.png" 
                         alt="KFAR Africa" 
                         class="h-12 w-12 mx-auto opacity-50">
                </div>
                <nav class="p-4 space-y-1">
                    <a href="#" class="sidebar-link block px-4 py-3 text-gray-700 font-medium rounded-lg" onclick="showSection('overview')">
                        <i class="fas fa-chart-line mr-3 w-5"></i>Overview
                    </a>
                    <a href="#" class="sidebar-link block px-4 py-3 text-gray-700 font-medium rounded-lg" onclick="showSection('customers')">
                        <i class="fas fa-users mr-3 w-5"></i>Customers
                    </a>
                    <a href="#" class="sidebar-link block px-4 py-3 text-gray-700 font-medium rounded-lg" onclick="showSection('vendors')">
                        <i class="fas fa-store mr-3 w-5"></i>Vendors
                    </a>
                    <a href="#" class="sidebar-link block px-4 py-3 text-gray-700 font-medium rounded-lg" onclick="showSection('timeline')">
                        <i class="fas fa-clock mr-3 w-5"></i>Timeline
                    </a>
                    <a href="#" class="sidebar-link block px-4 py-3 text-gray-700 font-medium rounded-lg" onclick="showSection('settings')">
                        <i class="fas fa-cog mr-3 w-5"></i>Settings
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto bg-gray-50">
                <!-- Overview Section -->
                <div id="overview-section" class="p-6">
                    <h2 class="text-2xl font-space font-bold mb-6">Dashboard Overview</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                                <span class="text-xs text-green-600 font-semibold status-badge">LIVE</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900" id="totalCustomers">0</h3>
                            <p class="text-sm text-gray-600 mt-1">Total Customers</p>
                            <div class="mt-4 text-xs text-gray-500">
                                <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                <span id="customerGrowth">+0%</span> from yesterday
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-store text-yellow-600 text-xl"></i>
                                </div>
                                <span class="text-xs text-yellow-600 font-semibold">PENDING</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900" id="totalVendors">0</h3>
                            <p class="text-sm text-gray-600 mt-1">Vendor Applications</p>
                            <div class="mt-4 text-xs text-gray-500">
                                <span id="pendingVendors">0</span> awaiting review
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-envelope text-blue-600 text-xl"></i>
                                </div>
                                <span class="text-xs text-blue-600 font-semibold">95% DELIVERED</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900" id="emailsSent">0</h3>
                            <p class="text-sm text-gray-600 mt-1">Emails Sent</p>
                            <div class="mt-4 text-xs text-gray-500">
                                <i class="fas fa-check text-green-500 mr-1"></i>
                                No spam issues
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                                </div>
                                <span class="text-xs text-purple-600 font-semibold">TRENDING</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900" id="conversionRate">0%</h3>
                            <p class="text-sm text-gray-600 mt-1">Conversion Rate</p>
                            <div class="mt-4 text-xs text-gray-500">
                                Form to signup
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-3">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="customers-section" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-space font-bold">Customer Waitlist</h2>
                        <div class="flex space-x-3">
                            <input type="text" placeholder="Search customers..." 
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                   onkeyup="searchTable('customers', this.value)">
                            <button onclick="addNewCustomer()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>Add Customer
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WhatsApp</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable" class="divide-y divide-gray-200">
                                <!-- Customer rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vendors Section -->
                <div id="vendors-section" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-space font-bold">Vendor Applications</h2>
                        <div class="flex space-x-3">
                            <input type="text" placeholder="Search vendors..." 
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                   onkeyup="searchTable('vendors', this.value)">
                            <button onclick="addNewVendor()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>Add Vendor
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applied</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vendorsTable" class="divide-y divide-gray-200">
                                <!-- Vendor rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Timeline Section -->
                <div id="timeline-section" class="p-6 hidden">
                    <h2 class="text-2xl font-space font-bold mb-6">Registration Timeline</h2>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div id="timelineContainer" class="space-y-6">
                            <!-- Timeline items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="p-6 hidden">
                    <h2 class="text-2xl font-space font-bold mb-6">Settings</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">Email Configuration</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">FROM Email</label>
                                    <input type="email" value="info@kfareats.com" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notification Email</label>
                                    <input type="email" value="bakielisrael@gmail.com" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-check-circle text-green-500"></i>
                                    <span class="text-sm text-gray-600">Domain authenticated with SendGrid</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">API Status</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">SendGrid</span>
                                    <span class="text-sm text-green-600 font-semibold">✓ Connected</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Google Workspace</span>
                                    <span class="text-sm text-green-600 font-semibold">✓ Active</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">DigitalOcean</span>
                                    <span class="text-sm text-green-600 font-semibold">✓ Deployed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4" id="editModalTitle">Edit Entry</h3>
            <form id="editForm" class="space-y-4">
                <div id="editFormFields">
                    <!-- Dynamic form fields will be inserted here -->
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data storage
        let registrations = {
            customers: [],
            vendors: []
        };
        
        let authToken = localStorage.getItem('adminToken');
        // The admin token should match ADMIN_TOKEN in your environment variables

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadData();
                } else {
                    alert(data.message || 'Invalid credentials');
                }
            } catch (error) {
                // Fallback to demo auth for local testing
                if (email === 'admin@kfareats.com' && password === 'admin123') {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadData();
                } else {
                    alert('Login failed. Please try again.');
                }
            }
        });

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Data loading
        async function loadData() {
            try {
                const response = await fetch('/api/admin/submissions', {
                    headers: {
                        'Authorization': `Bearer ${authToken || localStorage.getItem('adminToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    registrations.customers = data.submissions.filter(s => s.type === 'customer');
                    registrations.vendors = data.submissions.filter(s => s.type === 'vendor');
                    
                    // Ensure each entry has proper ID
                    registrations.customers = registrations.customers.map((c, index) => ({
                        ...c,
                        id: c.id || `customer-${Date.now()}-${index}`,
                        status: c.status || 'active'
                    }));
                    
                    registrations.vendors = registrations.vendors.map((v, index) => ({
                        ...v,
                        id: v.id || `vendor-${Date.now()}-${index}`,
                        status: v.status || 'pending'
                    }));
                } else if (response.status === 401) {
                    // Show demo data with note
                    showNotification('Using demo data. Configure ADMIN_TOKEN in environment to see real data.');
                    registrations = {
                        customers: [
                            {
                                id: 'demo-1',
                                name: 'Nir Avieli',
                                email: 'nir@example.com',
                                whatsapp: '+972 50-799-0372',
                                timestamp: new Date().toISOString(),
                                status: 'active'
                            }
                        ],
                        vendors: [
                            {
                                id: 'demo-2',
                                businessName: 'Organic Farm',
                                firstName: 'Test',
                                lastName: 'Vendor',
                                email: 'vendor@example.com',
                                phone: '+972 50-799-0372',
                                location: 'Dimona',
                                businessType: 'Organic Produce',
                                timestamp: new Date().toISOString(),
                                status: 'pending'
                            }
                        ]
                    };
                }
                
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data. Using demo data.');
                // Use demo data
                registrations = {
                    customers: [{
                        id: 'demo-1',
                        name: 'Demo Customer',
                        email: 'demo@example.com',
                        whatsapp: '+972 50-000-0000',
                        timestamp: new Date().toISOString(),
                        status: 'active'
                    }],
                    vendors: [{
                        id: 'demo-2',
                        businessName: 'Demo Business',
                        firstName: 'Demo',
                        lastName: 'Vendor',
                        email: 'vendor@demo.com',
                        phone: '+972 50-111-1111',
                        location: 'Tel Aviv',
                        businessType: 'Demo Type',
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    }]
                };
                updateDashboard();
            }
        }

        function updateDashboard() {
            // Update stats
            document.getElementById('totalCustomers').textContent = registrations.customers.length;
            document.getElementById('totalVendors').textContent = registrations.vendors.length;
            document.getElementById('emailsSent').textContent = (registrations.customers.length + registrations.vendors.length) * 2;
            document.getElementById('conversionRate').textContent = '12%';
            document.getElementById('customerGrowth').textContent = '+15%';
            document.getElementById('pendingVendors').textContent = registrations.vendors.filter(v => v.status === 'pending').length;
            
            // Update tables
            updateCustomersTable();
            updateVendorsTable();
            updateRecentActivity();
            updateTimeline();
        }

        function updateCustomersTable() {
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = registrations.customers.map(customer => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 editable" 
                             contenteditable="true" 
                             data-field="name" 
                             data-id="${customer.id}">${customer.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600 editable" 
                             contenteditable="true" 
                             data-field="email" 
                             data-id="${customer.id}">${customer.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600 editable" 
                             contenteditable="true" 
                             data-field="whatsapp" 
                             data-id="${customer.id}">${customer.whatsapp || 'Not provided'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${new Date(customer.timestamp).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            Active
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="editEntry('customer', ${customer.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteEntry('customer', ${customer.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateVendorsTable() {
            const tbody = document.getElementById('vendorsTable');
            tbody.innerHTML = registrations.vendors.map(vendor => `
                <tr>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900 editable" 
                             contenteditable="true" 
                             data-field="businessName" 
                             data-id="${vendor.id}">${vendor.businessName}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${vendor.firstName} ${vendor.lastName}</div>
                        <div class="text-sm text-gray-500">${vendor.email}</div>
                        <div class="text-sm text-gray-500">${vendor.phone}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${vendor.businessType}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${vendor.location}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${new Date(vendor.timestamp).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4">
                        <select class="text-xs font-semibold rounded-full px-3 py-1 
                                     ${vendor.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                       vendor.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                       'bg-red-100 text-red-800'}"
                                onchange="updateVendorStatus(${vendor.id}, this.value)">
                            <option value="pending" ${vendor.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${vendor.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${vendor.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="editEntry('vendor', ${vendor.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteEntry('vendor', ${vendor.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            const allActivities = [
                ...registrations.customers.map(c => ({...c, type: 'customer', action: 'joined waitlist'})),
                ...registrations.vendors.map(v => ({...v, type: 'vendor', action: 'applied'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
            
            container.innerHTML = allActivities.map(activity => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-${activity.type === 'customer' ? 'green' : 'yellow'}-100 
                                    flex items-center justify-center">
                            <i class="fas fa-${activity.type === 'customer' ? 'user' : 'store'} 
                                      text-${activity.type === 'customer' ? 'green' : 'yellow'}-600 text-sm"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                ${activity.type === 'customer' ? activity.name : activity.businessName} ${activity.action}
                            </p>
                            <p class="text-xs text-gray-500">${activity.email}</p>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">
                        ${new Date(activity.timestamp).toLocaleTimeString()}
                    </span>
                </div>
            `).join('');
        }

        function updateTimeline() {
            const container = document.getElementById('timelineContainer');
            const allEvents = [
                ...registrations.customers.map(c => ({...c, type: 'customer', icon: 'user', color: 'green'})),
                ...registrations.vendors.map(v => ({...v, type: 'vendor', icon: 'store', color: 'yellow'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = allEvents.map((event, index) => `
                <div class="flex">
                    <div class="flex flex-col items-center mr-4">
                        <div class="w-12 h-12 rounded-full bg-${event.color}-100 flex items-center justify-center">
                            <i class="fas fa-${event.icon} text-${event.color}-600"></i>
                        </div>
                        ${index < allEvents.length - 1 ? '<div class="w-0.5 h-full bg-gray-200 mt-2"></div>' : ''}
                    </div>
                    <div class="flex-1 pb-8">
                        <h4 class="text-sm font-semibold text-gray-900">
                            ${event.type === 'customer' ? event.name : event.businessName}
                        </h4>
                        <p class="text-sm text-gray-600 mt-1">
                            ${event.type === 'customer' ? 'Joined customer waitlist' : 'Applied as vendor'}
                        </p>
                        <p class="text-xs text-gray-500 mt-2">
                            ${new Date(event.timestamp).toLocaleString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Section navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(el => el.classList.add('hidden'));
            // Show selected section
            document.getElementById(`${section}-section`).classList.remove('hidden');
            // Update sidebar active state
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('bg-green-50', 'border-l-4', 'border-green-600', 'pl-3');
            });
            event.target.closest('.sidebar-link').classList.add('bg-green-50', 'border-l-4', 'border-green-600', 'pl-3');
        }

        // Search functionality
        function searchTable(type, query) {
            const table = document.getElementById(`${type}Table`);
            const rows = table.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            }
        }

        // Edit functionality
        function editEntry(type, id) {
            const entry = registrations[type + 's'].find(e => e.id === id);
            if (!entry) return;
            
            document.getElementById('editModalTitle').textContent = `Edit ${type === 'customer' ? 'Customer' : 'Vendor'}`;
            
            const fields = type === 'customer' 
                ? ['name', 'email', 'whatsapp']
                : ['businessName', 'firstName', 'lastName', 'email', 'phone', 'location', 'businessType'];
            
            document.getElementById('editFormFields').innerHTML = fields.map(field => `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ${field.charAt(0).toUpperCase() + field.slice(1).replace(/([A-Z])/g, ' $1')}
                    </label>
                    <input type="${field === 'email' ? 'email' : 'text'}" 
                           name="${field}" 
                           value="${entry[field] || ''}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
            `).join('');
            
            document.getElementById('editModal').classList.remove('hidden');
            
            document.getElementById('editForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const updates = {};
                for (let [key, value] of formData.entries()) {
                    updates[key] = value;
                    entry[key] = value;
                }
                
                try {
                    const response = await fetch(`/api/admin/submissions/${entry.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        updateDashboard();
                        closeEditModal();
                        showNotification('Changes saved successfully!');
                    } else {
                        // Update locally even if server fails
                        updateDashboard();
                        closeEditModal();
                        showNotification('Changes saved locally!');
                    }
                } catch (error) {
                    // Update locally on error
                    updateDashboard();
                    closeEditModal();
                    showNotification('Changes saved locally!');
                }
            };
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // Delete functionality
        async function deleteEntry(type, id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                try {
                    const response = await fetch(`/api/admin/submissions/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        registrations[type + 's'] = registrations[type + 's'].filter(e => e.id !== id);
                        updateDashboard();
                        showNotification('Entry deleted successfully!');
                    } else {
                        // Delete locally even if server fails
                        registrations[type + 's'] = registrations[type + 's'].filter(e => e.id !== id);
                        updateDashboard();
                        showNotification('Entry deleted locally!');
                    }
                } catch (error) {
                    // Delete locally on error
                    registrations[type + 's'] = registrations[type + 's'].filter(e => e.id !== id);
                    updateDashboard();
                    showNotification('Entry deleted locally!');
                }
            }
        }

        // Export functionality
        function exportData() {
            const timestamp = new Date();
            const data = {
                exportDate: timestamp.toISOString(),
                exportedBy: 'KFAR Shop Admin',
                summary: {
                    totalCustomers: registrations.customers.length,
                    totalVendors: registrations.vendors.length,
                    pendingVendors: registrations.vendors.filter(v => v.status === 'pending').length,
                    approvedVendors: registrations.vendors.filter(v => v.status === 'approved').length,
                    totalRegistrations: registrations.customers.length + registrations.vendors.length
                },
                customers: registrations.customers.map(c => ({
                    name: c.name,
                    email: c.email,
                    whatsapp: c.whatsapp || 'Not provided',
                    registeredDate: new Date(c.timestamp).toLocaleDateString(),
                    status: c.status
                })),
                vendors: registrations.vendors.map(v => ({
                    businessName: v.businessName,
                    contactName: `${v.firstName} ${v.lastName}`,
                    email: v.email,
                    phone: v.phone,
                    location: v.location,
                    businessType: v.businessType,
                    registeredDate: new Date(v.timestamp).toLocaleDateString(),
                    status: v.status,
                    message: v.message || 'No message'
                }))
            };
            
            // Create both JSON and CSV exports
            const jsonBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            
            // Create CSV for customers
            const customerCSV = 'Name,Email,WhatsApp,Registered Date,Status\n' + 
                registrations.customers.map(c => 
                    `"${c.name}","${c.email}","${c.whatsapp || 'Not provided'}","${new Date(c.timestamp).toLocaleDateString()}","${c.status}"`
                ).join('\n');
            
            // Create CSV for vendors
            const vendorCSV = 'Business Name,Contact Name,Email,Phone,Location,Type,Registered Date,Status\n' + 
                registrations.vendors.map(v => 
                    `"${v.businessName}","${v.firstName} ${v.lastName}","${v.email}","${v.phone}","${v.location}","${v.businessType}","${new Date(v.timestamp).toLocaleDateString()}","${v.status}"`
                ).join('\n');
            
            // Download JSON
            const a = document.createElement('a');
            a.href = jsonUrl;
            a.download = `kfar-data-${timestamp.toISOString().split('T')[0]}.json`;
            a.click();
            
            // Option to download CSVs
            if (confirm('Also export as CSV files for easy sharing?')) {
                // Customer CSV
                const customerBlob = new Blob([customerCSV], { type: 'text/csv' });
                const customerUrl = URL.createObjectURL(customerBlob);
                a.href = customerUrl;
                a.download = `kfar-customers-${timestamp.toISOString().split('T')[0]}.csv`;
                a.click();
                
                // Vendor CSV
                const vendorBlob = new Blob([vendorCSV], { type: 'text/csv' });
                const vendorUrl = URL.createObjectURL(vendorBlob);
                a.href = vendorUrl;
                a.download = `kfar-vendors-${timestamp.toISOString().split('T')[0]}.csv`;
                a.click();
                
                URL.revokeObjectURL(customerUrl);
                URL.revokeObjectURL(vendorUrl);
            }
            
            URL.revokeObjectURL(jsonUrl);
            showNotification('Data exported successfully!');
        }

        // Notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-x-full';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Refresh data
        function refreshData() {
            loadData();
            showNotification('Data refreshed!');
        }

        // Add new entries
        async function addNewCustomer() {
            const newCustomer = {
                type: 'customer',
                name: 'New Customer',
                email: 'new@example.com',
                whatsapp: '',
                timestamp: new Date().toISOString(),
                status: 'active'
            };
            
            try {
                const response = await fetch('/api/admin/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(newCustomer)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    registrations.customers.unshift(data.data);
                    updateDashboard();
                    editEntry('customer', data.data.id);
                } else {
                    // Add locally with temp ID
                    newCustomer.id = `temp-${Date.now()}`;
                    registrations.customers.unshift(newCustomer);
                    updateDashboard();
                    editEntry('customer', newCustomer.id);
                }
            } catch (error) {
                // Add locally on error
                newCustomer.id = `temp-${Date.now()}`;
                registrations.customers.unshift(newCustomer);
                updateDashboard();
                editEntry('customer', newCustomer.id);
            }
        }

        async function addNewVendor() {
            const newVendor = {
                type: 'vendor',
                businessName: 'New Business',
                firstName: 'First',
                lastName: 'Last',
                email: 'vendor@example.com',
                phone: '',
                location: 'Dimona',
                businessType: 'Type',
                timestamp: new Date().toISOString(),
                status: 'pending'
            };
            
            try {
                const response = await fetch('/api/admin/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(newVendor)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    registrations.vendors.unshift(data.data);
                    updateDashboard();
                    editEntry('vendor', data.data.id);
                } else {
                    // Add locally with temp ID
                    newVendor.id = `temp-${Date.now()}`;
                    registrations.vendors.unshift(newVendor);
                    updateDashboard();
                    editEntry('vendor', newVendor.id);
                }
            } catch (error) {
                // Add locally on error
                newVendor.id = `temp-${Date.now()}`;
                registrations.vendors.unshift(newVendor);
                updateDashboard();
                editEntry('vendor', newVendor.id);
            }
        }

        // Update vendor status
        async function updateVendorStatus(id, status) {
            const vendor = registrations.vendors.find(v => v.id === id);
            if (vendor) {
                vendor.status = status;
                
                try {
                    await fetch(`/api/admin/submissions/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ status })
                    });
                } catch (error) {
                    console.error('Error updating status:', error);
                }
                
                showNotification(`Vendor status updated to ${status}`);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Auto-focus login email
            document.getElementById('loginEmail').focus();
        });
    </script>
</body>
</html>